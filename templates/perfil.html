{% extends "base.html" %}

{% block title %}Meu Perfil{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-2">
                <i class="fas fa-user-circle text-primary me-2"></i> Meu Perfil
            </h1>
            <p class="text-muted">Gerencie suas informações pessoais e credenciais de acesso.</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Informações Pessoais</h6>
                </div>
                <div class="card-body">
                    <form id="formPerfil">
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome Completo</label>
                            <input type="text" class="form-control" id="nome" name="nome" value="{{ current_user.nome }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">E-mail</label>
                            <input type="email" class="form-control" id="email" name="email" value="{{ current_user.email }}" disabled>
                            <div class="form-text">O e-mail não pode ser alterado.</div>
                        </div>
                        <div class="mb-3">
                            <label for="perfil" class="form-label">Perfil de Acesso</label>
                            <input type="text" class="form-control" id="perfil" value="{{ current_user.perfil }}" disabled>
                        </div>
                        <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Alterar Senha</h6>
                </div>
                <div class="card-body">
                    <form id="formSenha">
                        <div class="mb-3">
                            <label for="senha_atual" class="form-label">Senha Atual</label>
                            <input type="password" class="form-control" id="senha_atual" name="senha_atual" required>
                        </div>
                        <div class="mb-3">
                            <label for="nova_senha" class="form-label">Nova Senha</label>
                            <input type="password" class="form-control" id="nova_senha" name="nova_senha" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmar_senha" class="form-label">Confirmar Nova Senha</label>
                            <input type="password" class="form-control" id="confirmar_senha" name="confirmar_senha" required>
                        </div>
                        <button type="submit" class="btn btn-warning">Alterar Senha</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const formPerfil = document.getElementById('formPerfil');
        const formSenha = document.getElementById('formSenha');

        // Função para mostrar toast (simulação)
        function mostrarToast(mensagem, tipo = 'info') {
            console.log(`[Toast ${tipo.toUpperCase()}]: ${mensagem}`);
            // Implementação real do toast
        }

        // 1. Atualizar Perfil
        formPerfil.addEventListener('submit', async function(e) {
            e.preventDefault();
            const nome = document.getElementById('nome').value;

            try {
                const response = await fetch('/api/perfil', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ nome: nome })
                });

                const data = await response.json();

                if (data.success) {
                    mostrarToast(data.message, 'success');
                } else {
                    mostrarToast(data.message, 'error');
                }
            } catch (error) {
                mostrarToast('Erro ao atualizar perfil.', 'error');
            }
        });

        // 2. Alterar Senha
        formSenha.addEventListener('submit', async function(e) {
            e.preventDefault();
            const senhaAtual = document.getElementById('senha_atual').value;
            const novaSenha = document.getElementById('nova_senha').value;
            const confirmarSenha = document.getElementById('confirmar_senha').value;

            if (novaSenha !== confirmarSenha) {
                mostrarToast('A nova senha e a confirmação não coincidem.', 'error');
                return;
            }

            try {
                const response = await fetch('/api/perfil/senha', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ senha_atual: senhaAtual, nova_senha: novaSenha })
                });

                const data = await response.json();

                if (data.success) {
                    mostrarToast(data.message, 'success');
                    formSenha.reset();
                } else {
                    mostrarToast(data.message, 'error');
                }
            } catch (error) {
                mostrarToast('Erro ao alterar senha.', 'error');
            }
        });
    });
</script>
{% endblock %}
