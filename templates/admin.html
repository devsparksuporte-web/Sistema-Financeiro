{% extends "base.html" %}

{% block title %}Administração{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabeçalho -->
    <div class="row mb-4">
        <div class="col">
            <h1 class="h3 mb-2">
                <i class="fas fa-cog text-primary me-2"></i> Painel de Administração
            </h1>
            <p class="text-muted">Gestão completa de usuários, permissões e configurações do sistema</p>
        </div>
    </div>
    
    <!-- Abas -->
    <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="usuarios-tab" data-bs-toggle="tab" 
                    data-bs-target="#usuarios" type="button" role="tab">
                <i class="fas fa-users me-1"></i> Usuários
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="configuracoes-tab" data-bs-toggle="tab" 
                    data-bs-target="#configuracoes" type="button" role="tab">
                <i class="fas fa-sliders-h me-1"></i> Configurações
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="backup-tab" data-bs-toggle="tab" 
                    data-bs-target="#backup" type="button" role="tab">
                <i class="fas fa-save me-1"></i> Backup
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="auditoria-tab" data-bs-toggle="tab" 
                    data-bs-target="#auditoria" type="button" role="tab">
                <i class="fas fa-clipboard-list me-1"></i> Auditoria
            </button>
        </li>
    </ul>
    
    <!-- Conteúdo das Abas -->
    <div class="tab-content" id="adminTabsContent">
        
        <!-- Aba: Usuários -->
        <div class="tab-pane fade show active" id="usuarios" role="tabpanel">
            <div class="row">
                <div class="col-md-4 mb-4">
                    <div class="card shadow">
                        <div class="card-header">
                            <h6 class="m-0 fw-bold">
                                <i class="fas fa-user-plus me-1"></i> Novo Usuário
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="formUsuario">
                                <div class="mb-3">
                                    <label class="form-label">Nome Completo *</label>
                                    <input type="text" class="form-control" name="nome" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Nome de Usuário *</label>
                                    <input type="text" class="form-control" name="username" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">E-mail *</label>
                                    <input type="email" class="form-control" name="email" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Senha *</label>
                                    <input type="password" class="form-control" name="senha" required minlength="6">
                                    <div class="form-text">
                                        Mínimo 6 caracteres
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Confirmar Senha *</label>
                                    <input type="password" class="form-control" name="confirmar_senha" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Perfil *</label>
                                    <select class="form-select" name="perfil" required>
                                        <option value="usuario">Usuário</option>
                                        <option value="analista">Analista</option>
                                        <option value="gerente">Gerente</option>
                                        <option value="admin">Administrador</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Departamento</label>
                                    <select class="form-select" name="departamento">
                                        <option value="">Selecione...</option>
                                        <option value="financeiro">Financeiro</option>
                                        <option value="vendas">Vendas</option>
                                        <option value="compras">Compras</option>
                                        <option value="rh">RH</option>
                                        <option value="ti">TI</option>
                                        <option value="administrativo">Administrativo</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Status *</label>
                                    <select class="form-select" name="status" required>
                                        <option value="ativo">Ativo</option>
                                        <option value="inativo">Inativo</option>
                                        <option value="bloqueado">Bloqueado</option>
                                        <option value="pendente">Pendente</option>
                                    </select>
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-primary" onclick="adicionarUsuario()">
                                        <i class="fas fa-plus me-1"></i> Adicionar Usuário
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-8">
                    <div class="card shadow">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="m-0 fw-bold">
                                <i class="fas fa-list me-1"></i> Usuários Cadastrados
                            </h6>
                            <div class="input-group w-auto">
                                <input type="text" id="buscaUsuario" class="form-control form-control-sm" 
                                       placeholder="Buscar usuário..." oninput="filtrarUsuarios()">
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Nome</th>
                                            <th>Usuário</th>
                                            <th>E-mail</th>
                                            <th>Perfil</th>
                                            <th>Departamento</th>
                                            <th>Status</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="usuariosTable">
                                        <tr>
                                            <td colspan="7" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Carregando...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Aba: Configurações -->
        <div class="tab-pane fade" id="configuracoes" role="tabpanel">
            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-header">
                            <h6 class="m-0 fw-bold">
                                <i class="fas fa-building me-1"></i> Configurações da Empresa
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="formConfigEmpresa">
                                <div class="mb-3">
                                    <label class="form-label">Nome da Empresa</label>
                                    <input type="text" class="form-control" id="empresaNome" 
                                           value="Contabilidade Carmo & Gueiros">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">CNPJ</label>
                                    <input type="text" class="form-control" id="empresaCNPJ" 
                                           value="00.000.000/0000-00">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Moeda Principal</label>
                                    <select class="form-select" id="moeda">
                                        <option value="BRL">Real Brasileiro (R$)</option>
                                        <option value="USD">Dólar Americano ($)</option>
                                        <option value="EUR">Euro (€)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Formato de Data</label>
                                    <select class="form-select" id="formatoData">
                                        <option value="dd/mm/yyyy">DD/MM/YYYY (Brasil)</option>
                                        <option value="mm/dd/yyyy">MM/DD/YYYY (EUA)</option>
                                        <option value="yyyy-mm-dd">YYYY-MM-DD (ISO)</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="card shadow">
                        <div class="card-header">
                            <h6 class="m-0 fw-bold">
                                <i class="fas fa-bell me-1"></i> Notificações
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="formConfigNotificacoes">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="notifDespesas" checked>
                                    <label class="form-check-label" for="notifDespesas">
                                        Alertas de Despesas
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="notifBackup" checked>
                                    <label class="form-check-label" for="notifBackup">
                                        Lembretes de Backup
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="notifRelatorios">
                                    <label class="form-check-label" for="notifRelatorios">
                                        Relatórios Automáticos
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="notifSistema">
                                    <label class="form-check-label" for="notifSistema">
                                        Atualizações do Sistema
                                    </label>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="card shadow mt-4">
                        <div class="card-header">
                            <h6 class="m-0 fw-bold">
                                <i class="fas fa-chart-line me-1"></i> Metas Financeiras
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="formConfigMetas">
                                <div class="mb-3">
                                    <label class="form-label">Meta de Faturamento Mensal (R$)</label>
                                    <input type="number" class="form-control" id="metaFaturamento" value="50000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Meta de Lucro Mensal (R$)</label>
                                    <input type="number" class="form-control" id="metaLucro" value="15000">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Orçamento de Despesas (R$)</label>
                                    <input type="number" class="form-control" id="metaDespesas" value="30000">
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 text-center">
                <button class="btn btn-primary btn-lg" onclick="salvarConfiguracoes()">
                    <i class="fas fa-save me-2"></i> Salvar Todas as Configurações
                </button>
            </div>
        </div>
        
        <!-- Aba: Backup -->
        <div class="tab-pane fade" id="backup" role="tabpanel">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card shadow">
                        <div class="card-header">
                            <h6 class="m-0 fw-bold">
                                <i class="fas fa-database me-1"></i> Criar Backup
                            </h6>
                        </div>
                        <div class="card-body">
                            <form id="formBackup">
                                <div class="mb-3">
                                    <label class="form-label">Descrição</label>
                                    <input type="text" class="form-control" 
                                           placeholder="Ex: Backup mensal - Janeiro 2024">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tipo de Backup</label>
                                    <select class="form-select">
                                        <option value="completo">Completo (Todos os dados)</option>
                                        <option value="parcial">Parcial (Apenas dados críticos)</option>
                                        <option value="incremental">Incremental (Apenas alterações)</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Senha de Proteção (Opcional)</label>
                                    <input type="password" class="form-control" 
                                           placeholder="Senha para proteger o backup">
                                </div>
                                <div class="d-grid">
                                    <button type="button" class="btn btn-success" onclick="criarBackup()">
                                        <i class="fas fa-save me-1"></i> Criar Backup Agora
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-6 mb-4">
                    <div class="card shadow h-100">
                        <div class="card-header">
                            <h6 class="m-0 fw-bold">
                                <i class="fas fa-history me-1"></i> Backups Disponíveis
                            </h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="list-group list-group-flush" id="backupsList">
                                <div class="list-group-item text-center py-4">
                                    <i class="fas fa-database fa-2x text-muted mb-3"></i>
                                    <p class="text-muted">Nenhum backup disponível</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Aba: Auditoria -->
        <div class="tab-pane fade" id="auditoria" role="tabpanel">
            <div class="card shadow">
                <div class="card-header">
                    <h6 class="m-0 fw-bold">
                        <i class="fas fa-clipboard-list me-1"></i> Logs de Auditoria
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <label class="form-label">Período</label>
                            <select class="form-select" onchange="carregarAuditoria()">
                                <option value="7">Últimos 7 dias</option>
                                <option value="30">Últimos 30 dias</option>
                                <option value="90">Últimos 90 dias</option>
                                <option value="365">Últimos 365 dias</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Ação</label>
                            <select class="form-select" onchange="carregarAuditoria()">
                                <option value="todas">Todas as Ações</option>
                                <option value="login">Login</option>
                                <option value="logout">Logout</option>
                                <option value="create">Criação</option>
                                <option value="update">Atualização</option>
                                <option value="delete">Exclusão</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Usuário</label>
                            <select class="form-select" onchange="carregarAuditoria()">
                                <option value="todos">Todos os Usuários</option>
                                <!-- Usuários serão carregados via JavaScript -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Data/Hora</th>
                                    <th>Usuário</th>
                                    <th>Ação</th>
                                    <th>Recurso</th>
                                    <th>Detalhes</th>
                                    <th>IP</th>
                                </tr>
                            </thead>
                            <tbody id="auditoriaTable">
                                <tr>
                                    <td colspan="6" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Carregando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <button class="btn btn-outline-primary" onclick="exportarAuditoria()">
                        <i class="fas fa-download me-1"></i> Exportar Logs
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Formatar data
function formatDateTime(dateString) {
    if (!dateString) return '-';
    const date = new Date(dateString);
    return date.toLocaleString('pt-BR');
}

// Carregar usuários
async function carregarUsuarios() {
    try {
        const response = await fetch('/api/admin/usuarios');
        const data = await response.json();
        
        if (data.success) {
            atualizarTabelaUsuarios(data.usuarios);
        } else {
            throw new Error(data.message);
        }
        
    } catch (error) {
        console.error('Erro ao carregar usuários:', error);
        mostrarToast('Erro ao carregar usuários', 'error');
    }
}

// Atualizar tabela de usuários
function atualizarTabelaUsuarios(usuarios) {
    const tbody = document.getElementById('usuariosTable');
    
    if (usuarios.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-4">
                    <i class="fas fa-users fa-2x text-muted mb-3"></i>
                    <p class="text-muted">Nenhum usuário cadastrado</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    
    usuarios.forEach(usuario => {
        // Status badge
        let statusBadge = '';
        switch(usuario.status) {
            case 'ativo':
                statusBadge = '<span class="badge bg-success">Ativo</span>';
                break;
            case 'inativo':
                statusBadge = '<span class="badge bg-secondary">Inativo</span>';
                break;
            case 'bloqueado':
                statusBadge = '<span class="badge bg-danger">Bloqueado</span>';
                break;
            case 'pendente':
                statusBadge = '<span class="badge bg-warning">Pendente</span>';
                break;
        }
        
        // Perfil badge
        let perfilBadge = '';
        switch(usuario.perfil) {
            case 'admin':
                perfilBadge = '<span class="badge bg-danger">Admin</span>';
                break;
            case 'gerente':
                perfilBadge = '<span class="badge bg-primary">Gerente</span>';
                break;
            case 'analista':
                perfilBadge = '<span class="badge bg-info">Analista</span>';
                break;
            default:
                perfilBadge = '<span class="badge bg-secondary">Usuário</span>';
        }
        
        // Departamento
        const departamentos = {
            'financeiro': 'Financeiro',
            'vendas': 'Vendas',
            'compras': 'Compras',
            'rh': 'RH',
            'ti': 'TI',
            'administrativo': 'Administrativo'
        };
        
        const departamento = departamentos[usuario.departamento] || usuario.departamento || '-';
        
        html += `
        <tr>
            <td>
                <div class="fw-bold">${usuario.nome}</div>
                <small class="text-muted">${usuario.email}</small>
            </td>
            <td>${usuario.username}</td>
            <td>${usuario.email}</td>
            <td>${perfilBadge}</td>
            <td>${departamento}</td>
            <td>${statusBadge}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="editarUsuario(${usuario.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="excluirUsuario(${usuario.id})" 
                            ${usuario.username === 'admin' ? 'disabled' : ''}>
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Filtrar usuários
function filtrarUsuarios() {
    const busca = document.getElementById('buscaUsuario').value.toLowerCase();
    const linhas = document.getElementById('usuariosTable').querySelectorAll('tr');
    
    linhas.forEach(linha => {
        const texto = linha.textContent.toLowerCase();
        if (texto.includes(busca)) {
            linha.style.display = '';
        } else {
            linha.style.display = 'none';
        }
    });
}

// Adicionar usuário
async function adicionarUsuario() {
    try {
        const form = document.getElementById('formUsuario');
        const formData = new FormData(form);
        const dados = Object.fromEntries(formData.entries());
        
        // Validações
        if (dados.senha !== dados.confirmar_senha) {
            mostrarToast('As senhas não coincidem', 'error');
            return;
        }
        
        if (dados.senha.length < 6) {
            mostrarToast('A senha deve ter pelo menos 6 caracteres', 'error');
            return;
        }
        
        const response = await fetch('/api/admin/usuarios', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        });
        
        const data = await response.json();
        
        if (data.success) {
            form.reset();
            mostrarToast('Usuário adicionado com sucesso!', 'success');
            carregarUsuarios();
        } else {
            throw new Error(data.message);
        }
        
    } catch (error) {
        console.error('Erro ao adicionar usuário:', error);
        mostrarToast(error.message || 'Erro ao adicionar usuário', 'error');
    }
}

// Editar usuário
async function editarUsuario(id) {
    try {
        const response = await fetch(`/api/admin/usuarios/${id}`);
        const data = await response.json();
        
        if (data.success) {
            const usuario = data.usuario;
            const form = document.getElementById('formUsuario');
            
            // Preencher formulário
            Object.keys(usuario).forEach(key => {
                const input = form.querySelector(`[name="${key}"]`);
                if (input) {
                    input.value = usuario[key] || '';
                }
            });
            
            // Ocultar campos de senha
            form.querySelector('[name="senha"]').required = false;
            form.querySelector('[name="confirmar_senha"]').required = false;
            
            form.dataset.id = id;
            
            // Mudar texto do botão
            const botao = form.querySelector('button');
            botao.innerHTML = '<i class="fas fa-save me-1"></i> Atualizar Usuário';
            botao.onclick = function() { atualizarUsuario(id); };
            
            mostrarToast('Preencha os campos que deseja alterar', 'info');
        }
        
    } catch (error) {
        console.error('Erro ao carregar usuário:', error);
        mostrarToast('Erro ao carregar usuário', 'error');
    }
}

// Atualizar usuário
async function atualizarUsuario(id) {
    try {
        const form = document.getElementById('formUsuario');
        const formData = new FormData(form);
        const dados = Object.fromEntries(formData.entries());
        
        // Se senha estiver vazia, remover do objeto
        if (!dados.senha) {
            delete dados.senha;
            delete dados.confirmar_senha;
        } else {
            if (dados.senha !== dados.confirmar_senha) {
                mostrarToast('As senhas não coincidem', 'error');
                return;
            }
        }
        
        const response = await fetch(`/api/admin/usuarios/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(dados)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Resetar formulário
            form.reset();
            delete form.dataset.id;
            
            // Restaurar botão original
            const botao = form.querySelector('button');
            botao.innerHTML = '<i class="fas fa-plus me-1"></i> Adicionar Usuário';
            botao.onclick = function() { adicionarUsuario(); };
            
            // Restaurar campos de senha
            form.querySelector('[name="senha"]').required = true;
            form.querySelector('[name="confirmar_senha"]').required = true;
            
            mostrarToast('Usuário atualizado com sucesso!', 'success');
            carregarUsuarios();
        } else {
            throw new Error(data.message);
        }
        
    } catch (error) {
        console.error('Erro ao atualizar usuário:', error);
        mostrarToast(error.message || 'Erro ao atualizar usuário', 'error');
    }
}

// Excluir usuário
async function excluirUsuario(id) {
    if (!confirm('Tem certeza que deseja excluir este usuário?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/usuarios/${id}`, {
            method: 'DELETE'
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarToast('Usuário excluído com sucesso', 'success');
            carregarUsuarios();
        } else {
            throw new Error(data.message);
        }
        
    } catch (error) {
        console.error('Erro ao excluir usuário:', error);
        mostrarToast(error.message || 'Erro ao excluir usuário', 'error');
    }
}

// Carregar configurações
async function carregarConfiguracoes() {
    try {
        const response = await fetch('/api/configuracoes');
        const data = await response.json();
        
        // Preencher formulários com os dados
        if (data.empresa_nome) {
            document.getElementById('empresaNome').value = data.empresa_nome;
        }
        if (data.empresa_cnpj) {
            document.getElementById('empresaCNPJ').value = data.empresa_cnpj;
        }
        if (data.moeda) {
            document.getElementById('moeda').value = data.moeda;
        }
        if (data.formato_data) {
            document.getElementById('formatoData').value = data.formato_data;
        }
        if (data.meta_faturamento) {
            document.getElementById('metaFaturamento').value = data.meta_faturamento;
        }
        if (data.meta_lucro) {
            document.getElementById('metaLucro').value = data.meta_lucro;
        }
        if (data.meta_despesas) {
            document.getElementById('metaDespesas').value = data.meta_despesas;
        }
        
        // Checkboxes de notificações
        document.getElementById('notifDespesas').checked = data.notificacoes_despesas === 'true';
        document.getElementById('notifBackup').checked = data.notificacoes_backup === 'true';
        document.getElementById('notifRelatorios').checked = data.notificacoes_relatorios === 'true';
        document.getElementById('notifSistema').checked = data.notificacoes_sistema === 'true';
        
    } catch (error) {
        console.error('Erro ao carregar configurações:', error);
    }
}

// Salvar configurações
async function salvarConfiguracoes() {
    try {
        const configuracao = {
            empresa_nome: document.getElementById('empresaNome').value,
            empresa_cnpj: document.getElementById('empresaCNPJ').value,
            moeda: document.getElementById('moeda').value,
            formato_data: document.getElementById('formatoData').value,
            meta_faturamento: document.getElementById('metaFaturamento').value,
            meta_lucro: document.getElementById('metaLucro').value,
            meta_despesas: document.getElementById('metaDespesas').value,
            notificacoes_despesas: document.getElementById('notifDespesas').checked.toString(),
            notificacoes_backup: document.getElementById('notifBackup').checked.toString(),
            notificacoes_relatorios: document.getElementById('notifRelatorios').checked.toString(),
            notificacoes_sistema: document.getElementById('notifSistema').checked.toString()
        };
        
        const response = await fetch('/api/configuracoes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(configuracao)
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarToast('Configurações salvas com sucesso!', 'success');
        } else {
            throw new Error(data.message);
        }
        
    } catch (error) {
        console.error('Erro ao salvar configurações:', error);
        mostrarToast(error.message || 'Erro ao salvar configurações', 'error');
    }
}

// Carregar backups
async function carregarBackups() {
    try {
        const response = await fetch('/api/backup', { method: 'GET' });
        const data = await response.json();
        
        atualizarListaBackups(data.backups);
        
    } catch (error) {
        console.error('Erro ao carregar backups:', error);
        mostrarToast('Erro ao carregar backups', 'error');
    }
}

// Atualizar lista de backups
function atualizarListaBackups(backups) {
    const container = document.getElementById('backupsList');
    
    if (!backups || backups.length === 0) {
        container.innerHTML = `
            <div class="list-group-item text-center py-4">
                <i class="fas fa-database fa-2x text-muted mb-3"></i>
                <p class="text-muted">Nenhum backup disponível</p>
            </div>
        `;
        return;
    }
    
    let html = '';
    
    backups.forEach(backup => {
        const data = new Date(backup.data).toLocaleDateString('pt-BR');
        const tamanho = formatBytes(backup.tamanho || 0);
        
        html += `
        <div class="list-group-item">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">${backup.descricao}</h6>
                    <small class="text-muted">
                        ${data} • ${tamanho}
                        ${backup.protegido ? '• <i class="fas fa-lock text-warning"></i>' : ''}
                    </small>
                </div>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary" onclick="restaurarBackup(${backup.id})">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="btn btn-outline-danger" onclick="excluirBackup(${backup.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
        `;
    });
    
    container.innerHTML = html;
}

// Criar backup
async function criarBackup() {
    try {
        const form = document.getElementById('formBackup');
        const formData = new FormData(form);
        const dados = Object.fromEntries(formData.entries());
        
        const response = await fetch('/api/backup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                acao: 'criar',
                descricao: dados[0] || 'Backup automático',
                tipo: dados[1] || 'completo',
                senha: dados[2] || ''
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            form.reset();
            mostrarToast('Backup criado com sucesso!', 'success');
            carregarBackups();
        } else {
            throw new Error(data.message);
        }
        
    } catch (error) {
        console.error('Erro ao criar backup:', error);
        mostrarToast(error.message || 'Erro ao criar backup', 'error');
    }
}

// Restaurar backup
async function restaurarBackup(id) {
    if (!confirm('Tem certeza que deseja restaurar este backup? Os dados atuais serão substituídos.')) {
        return;
    }
    
    try {
        const senha = prompt('Digite a senha do backup (se houver):') || '';
        
        const response = await fetch('/api/backup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                acao: 'restaurar',
                id: id,
                senha: senha
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarToast('Backup restaurado com sucesso! O sistema será recarregado.', 'success');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            throw new Error(data.message);
        }
        
    } catch (error) {
        console.error('Erro ao restaurar backup:', error);
        mostrarToast(error.message || 'Erro ao restaurar backup', 'error');
    }
}

// Excluir backup
async function excluirBackup(id) {
    if (!confirm('Tem certeza que deseja excluir este backup?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/backup', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                acao: 'excluir',
                id: id
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            mostrarToast('Backup excluído com sucesso', 'success');
            carregarBackups();
        } else {
            throw new Error(data.message);
        }
        
    } catch (error) {
        console.error('Erro ao excluir backup:', error);
        mostrarToast(error.message || 'Erro ao excluir backup', 'error');
    }
}

// Formatar bytes
function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Carregar auditoria
async function carregarAuditoria() {
    try {
        const periodo = document.querySelector('#auditoria select').value;
        const acao = document.querySelectorAll('#auditoria select')[1].value;
        const usuario = document.querySelectorAll('#auditoria select')[2].value;
        
        const query = `?dias=${periodo}&acao=${acao}&usuario_id=${usuario}`;
        
        const response = await fetch(`/api/admin/logs${query}`);
        const data = await response.json();
        
        atualizarTabelaAuditoria(data.logs);
        
    } catch (error) {
        console.error('Erro ao carregar auditoria:', error);
        mostrarToast('Erro ao carregar logs de auditoria', 'error');
    }
}

// Atualizar tabela de auditoria
function atualizarTabelaAuditoria(logs) {
    const tbody = document.getElementById('auditoriaTable');
    
    if (!logs || logs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <i class="fas fa-clipboard-list fa-2x text-muted mb-3"></i>
                    <p class="text-muted">Nenhum log encontrado</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    
    logs.forEach(log => {
        // Ícone por ação
        let icon = 'clipboard';
        let color = 'secondary';
        
        switch(log.acao) {
            case 'login':
                icon = 'sign-in-alt';
                color = 'success';
                break;
            case 'logout':
                icon = 'sign-out-alt';
                color = 'warning';
                break;
            case 'create':
                icon = 'plus';
                color = 'primary';
                break;
            case 'update':
                icon = 'edit';
                color = 'info';
                break;
            case 'delete':
                icon = 'trash';
                color = 'danger';
                break;
        }
        
        html += `
        <tr>
            <td>${formatDateTime(log.data)}</td>
            <td>
                <div class="fw-bold">${log.usuario_nome}</div>
                <small class="text-muted">${log.ip}</small>
            </td>
            <td>
                <span class="badge bg-${color}">
                    <i class="fas fa-${icon} me-1"></i>${log.acao}
                </span>
            </td>
            <td>${log.recurso || '-'}</td>
            <td>
                <div class="small">${JSON.stringify(log.detalhes) || '-'}</div>
            </td>
            <td>${log.ip}</td>
        </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Exportar auditoria
async function exportarAuditoria() {
    try {
        const periodo = document.querySelector('#auditoria select').value;
        const query = `?dias=${periodo}&formato=csv`;
        
        window.open(`/api/auditoria/exportar${query}`, '_blank');
        mostrarToast('Logs exportados com sucesso!', 'success');
        
    } catch (error) {
        console.error('Erro ao exportar auditoria:', error);
        mostrarToast('Erro ao exportar logs', 'error');
    }
}

// Mostrar toast (Usando a função global showToast de base.html)
function mostrarToast(mensagem, tipo = 'info') {
    showToast(mensagem, tipo);
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    // Carregar dados iniciais
    carregarUsuarios();
    carregarConfiguracoes();
    carregarBackups();
    carregarAuditoria();
    
    // Atualizar auditoria a cada minuto
    setInterval(carregarAuditoria, 60000);
});
</script>
{% endblock %}